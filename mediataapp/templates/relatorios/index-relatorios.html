{% extends '_layout/base.html' %}
{% load permission_tags %}

{% block conteudo %}
<div class="container-fluid">
    <style>
        /* Estilos para os botões de filtro */
        .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }

        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

        /* Ajuste para os botões ficarem alinhados */
        .d-flex.gap-2 {
            gap: 0.5rem;
        }

        /* Tooltip para o botão de limpar */
        [title] {
            position: relative;
        }

        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
    </style>
    <!-- Filtros -->
    <!-- Filtros -->
    <form action="{% url 'relatorios' %}" method="post" class="card mb-4">
        {% csrf_token %}
        <div class="card-body">
            <h5 class="card-title">Filtros</h5>
            
            <!-- Botão para abrir o modal de filtros personalizados -->
            <div class="mb-3">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#customDateModal">
                    <i class="bi bi-sliders"></i> Filtros Avançados
                </button>
                <button type="button" class="btn btn-outline-danger ms-2" onclick="limparFiltros()">
                    <i class="bi bi-x-circle"></i> Limpar Tudo
                </button>
            </div>

            <div class="row">
                <!-- Período -->
                <div class="col-md-2">
                    <label for="date-range" class="form-label">Período</label>
                    <select class="form-select" name="date_range" id="date-range">
                        <option value="7" {% if filtro_date_range == "7" %}selected{% endif %}>Últimos 7 dias</option>
                        <option value="30" {% if filtro_date_range == "30" or not filtro_date_range %}selected{% endif %}>Últimos 30 dias</option>
                        <option value="90" {% if filtro_date_range == "90" %}selected{% endif %}>Últimos 3 meses</option>
                        <option value="custom" {% if filtro_date_range == "custom" %}selected{% endif %}>Personalizado</option>
                    </select>
                </div>

                <!-- Cliente -->
                <div class="col-md-2">
                    <label for="cliente" class="form-label">Cliente</label>
                    <select class="form-select select2" name="cliente" id="cliente" data-placeholder="Selecione um cliente">
                        <option value="all" {% if filtro_cliente == "all" or not filtro_cliente %}selected{% endif %}>Todos os Clientes</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" {% if filtro_cliente == cliente.id|stringformat:"s" %}selected{% endif %}>
                            {{ cliente.nome_razao_social }} - {{ cliente.cpf_cnpj }}
                        </option>
                        {% empty %}
                        <option value="">Nenhum cliente cadastrado</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Colaborador -->
                <div class="col-md-2">
                    <label for="colaborador" class="form-label">Colaborador</label>
                    <select class="form-select select2" name="colaborador" id="colaborador" data-placeholder="Selecione um colaborador">
                        <option value="all" {% if filtro_colaborador == "all" or not filtro_colaborador %}selected{% endif %}>Todos os Colaboradores</option>
                        {% for colaborador in colaboradores %}
                        <option value="{{ colaborador.id }}" {% if filtro_colaborador == colaborador.id|stringformat:"s" %}selected{% endif %}>
                            {% if colaborador.cpf %}
                            {{ colaborador.nome_completo }}
                            {% elif colaborador.cnpj %}
                            {{ colaborador.razao_social }}
                            {% endif %}
                        </option>
                        {% empty %}
                        <option value="">Nenhum colaborador</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status -->
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" name="status" id="status">
                        <option value="T" {% if filtro_status == "T" or not filtro_status %}selected{% endif %}>Todos</option>
                        <option value="L" {% if filtro_status == "L" %}selected{% endif %}>Levantamento</option>
                        <option value="C" {% if filtro_status == "C" %}selected{% endif %}>Cotação</option>
                        <option value="A" {% if filtro_status == "A" %}selected{% endif %}>Aprovado</option>
                        <option value="E" {% if filtro_status == "E" %}selected{% endif %}>Em Execução</option>
                        <option value="X" {% if filtro_status == "X" %}selected{% endif %}>Executado</option>
                        <option value="V" {% if filtro_status == "V" %}selected{% endif %}>Vistoriado</option>
                        <option value="F" {% if filtro_status == "F" %}selected{% endif %}>Finalizado</option>
                        <option value="R" {% if filtro_status == "R" %}selected{% endif %}>Rejeitado</option>
                    </select>
                </div>

                <!-- Usuário (apenas para gerentes) -->
                {% if user|has_role:'gerente' %}
                <div class="col-md-2">
                    <label for="usuario" class="form-label">Usuário</label>
                    <select class="form-select" name="usuario" id="usuario">
                        <option value="all" {% if filtro_usuario == "all" %}selected{% endif %}>Todos</option>
                        {% for usuario in usuarios %}
                        <option value="{{ usuario.id }}" {% if filtro_usuario == usuario.id|stringformat:"s" %}selected{% endif %}>
                            {{ usuario.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <!-- Botões Aplicar e Limpar -->
                <div class="col-md-2 d-flex align-items-end">
                    <div class="w-100 d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="bi bi-funnel"></i> Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Dashboard de Métricas -->
    <div class="dashboard mb-4">
        <div class="stat-card">
            <h3>Orçamentos Totais</h3>
            <div class="stat-value">R$ {{ orcamento_total|floatformat:2 }}</div>
        </div>
        <div class="stat-card">
            <h3>Ticket Médio</h3>
            <div class="stat-value">R$ {{ ticket_medio|floatformat:2 }}</div>
        </div>
        <div class="stat-card">
            <h3>Pagamentos</h3>
            <div class="stat-value">R$ {{ total_pagamentos|floatformat:2 }}</div>
        </div>
        <div class="stat-card">
            <h3>Lucro</h3>
            <div class="stat-value {% if total_lucros >= 0 %}stat-value-lucro{% else %}stat-value-prejuizo{% endif %}">
                R$ {{ total_lucros|floatformat:2 }}
            </div>
            <small class="text-muted">
                {% if eh_lucro %}+{% else %}-{% endif %}
                {{ percentual_lucro|floatformat:1 }}% sobre vendas
            </small>
        </div>
        <div class="stat-card">
            <h3>Novos Clientes</h3>
            <div class="stat-value">{{ novos_clientes }}</div>
        </div>
    </div>

    <!-- Tabela de Tickets -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Tickets ({{ tickets.count }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="datatablesSimple">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuário</th>
                            <th>Cliente</th>
                            <th>Colaborador</th>
                            <th>Status</th>
                            <th>Data de Criação</th>
                            <th>Orçamentos</th>
                            <th>Pagamentos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                        <tr>
                            <td><strong>#{{ ticket.ticket }}</strong></td>
                            <td>{{ ticket.usuario.username }}</td>
                            <td>
                                {% if ticket.cliente %}
                                    {{ ticket.cliente.nome_razao_social }}
                                {% else %}
                                    <span class="text-muted">Nenhum</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ticket.colaborador %}
                                    {{ ticket.colaborador }}
                                {% else %}
                                    <span class="text-muted">Nenhum</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if ticket.status == 'L' %}bg-warning text-white
                                    {% elif ticket.status == 'C' %}bg-primary text-dark
                                    {% elif ticket.status == 'A' %}bg-secondary text-white
                                    {% elif ticket.status == 'E' %}bg-info text-dark
                                    {% elif ticket.status == 'X' %}bg-warning text-dark
                                    {% elif ticket.status == 'V' %}bg-success text-white
                                    {% elif ticket.status == 'F' %}bg-danger text-white
                                    {% elif ticket.status == 'R' %}bg-light text-dark border
                                    {% else %}bg-secondary text-white{% endif %}">
                                    {% if ticket.status == 'L' %}<i class="bi bi-clipboard-data me-1"></i>
                                    {% elif ticket.status == 'C' %}<i class="bi bi-check-circle me-1"></i>
                                    {% elif ticket.status == 'A' %}<i class="bi bi-check-all me-1"></i>
                                    {% elif ticket.status == 'E' %}<i class="bi bi-gear-wide-connected me-1"></i>
                                    {% elif ticket.status == 'X' %}<i class="bi bi-check-circle me-1"></i>
                                    {% elif ticket.status == 'V' %}<i class="bi bi-eye-fill me-1"></i>
                                    {% elif ticket.status == 'F' %}<i class="bi bi-flag-fill me-1"></i>
                                    {% elif ticket.status == 'R' %}<i class="bi bi-x-circle-fill me-1"></i>
                                    {% endif %}
                                    {{ ticket.get_status_display }}
                                </span>
                            </td>
                            <td>{{ ticket.data_criacao|date:"d/m/Y" }}</td>
                            <td>R$ {{ ticket.total_orcamentos|floatformat:2 }}</td>
                            <td>R$ {{ ticket.total_pagamentos|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox display-4"></i>
                                    <p class="mt-2">Nenhum ticket encontrado com os filtros aplicados</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para datas personalizadas -->
<div class="modal fade" id="customDateModal" tabindex="-1" aria-labelledby="customDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{% url 'relatorios' %}" method="post"> 
                {% csrf_token %}
                <input type="hidden" name="date_range" value="custom">
                <div class="modal-header">
                    <h5 class="modal-title" id="customDateModalLabel">Filtros Avançados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_inicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                                       value="{{ filtro_data_inicio|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_fim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="data_fim" name="data_fim"
                                       value="{{ filtro_data_fim|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cliente_modal" class="form-label">Cliente</label>
                        <select class="form-select select2" name="cliente" id="cliente_modal" data-placeholder="Selecione um cliente">
                            <option value="all" {% if filtro_cliente == "all" or not filtro_cliente %}selected{% endif %}>Todos os Clientes</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if filtro_cliente == cliente.id|stringformat:"s" %}selected{% endif %}>
                                {{ cliente.nome_razao_social }} - {{ cliente.cpf_cnpj }}
                            </option>
                            {% empty %}
                            <option value="">Nenhum cliente cadastrado</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="colaborador_modal" class="form-label">Colaborador</label>
                        <select class="form-select select2" name="colaborador" id="colaborador_modal" data-placeholder="Selecione um colaborador">
                            <option value="all" {% if filtro_colaborador == "all" or not filtro_colaborador %}selected{% endif %}>Todos os Colaboradores</option>
                            {% for colaborador in colaboradores %}
                            <option value="{{ colaborador.id }}" {% if filtro_colaborador == colaborador.id|stringformat:"s" %}selected{% endif %}>
                                {% if colaborador.cpf %}
                                {{ colaborador.nome_completo }}
                                {% elif colaborador.cnpj %}
                                {{ colaborador.razao_social }}
                                {% endif %}
                            </option>
                            {% empty %}
                            <option value="">Nenhum colaborador</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status (Selecione múltiplos)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="T" id="status_todos" 
                                        {% if "T" in filtro_status_list or not filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_todos">Todos</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="L" id="status_levantamento" 
                                        {% if "L" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_levantamento">Levantamento</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="C" id="status_cotacao" 
                                        {% if "C" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_cotacao">Cotação</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="A" id="status_aprovado" 
                                        {% if "A" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_aprovado">Aprovado</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="E" id="status_execucao" 
                                        {% if "E" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_execucao">Em Execução</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="X" id="status_executado" 
                                        {% if "X" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_executado">Executado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="V" id="status_vistoriado" 
                                        {% if "V" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_vistoriado">Vistoriado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="F" id="status_finalizado" 
                                        {% if "F" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_finalizado">Finalizado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input status-checkbox" type="checkbox" name="status" value="R" id="status_rejeitado" 
                                        {% if "R" in filtro_status_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_rejeitado">Rejeitado</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if user|has_role:'gerente' %}
                    <div class="mb-3">
                        <label for="usuario_modal" class="form-label">Usuário</label>
                        <select class="form-select" name="usuario" id="usuario_modal">
                            <option value="all" {% if filtro_usuario == "all" %}selected{% endif %}>Todos</option>
                            {% for usuario in usuarios %}
                            <option value="{{ usuario.id }}" {% if filtro_usuario == usuario.id|stringformat:"s" %}selected{% endif %}>
                                {{ usuario.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="limparFiltrosModal()">
                        <i class="bi bi-eraser"></i> Limpar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> Aplicar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card h3 {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #007bff;
}

.stat-value-lucro {
    color: #28a745;
}

.stat-value-prejuizo {
    color: #dc3545;
}

.badge {
    font-size: 0.8em;
    padding: 0.5em 0.8em;
    border-radius: 0.375rem;
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
    color: #495057;
}

/* Estilos para os checkboxes no modal */
#customDateModal .form-check {
    margin-bottom: 0.5rem;
}

#customDateModal .form-check-input {
    margin-top: 0.2rem;
}

#customDateModal .form-check-label {
    margin-left: 0.5rem;
}

#customDateModal .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>

<script>
// Inicializar Select2
$(document).ready(function() {
    // Select2 do formulário principal
    $('#cliente').select2({
        placeholder: "Selecione um cliente",
        allowClear: true,
        width: '100%'
    });
    
    $('#colaborador').select2({
        placeholder: "Selecione um colaborador",
        allowClear: true,
        width: '100%'
    });
    
    // Inicializar Select2 dentro do modal quando aberto
    $('#customDateModal').on('shown.bs.modal', function () {
        $('#cliente_modal').select2({
            placeholder: "Selecione um cliente",
            allowClear: true,
            width: '100%',
            dropdownParent: $('#customDateModal')
        });
        
        $('#colaborador_modal').select2({
            placeholder: "Selecione um colaborador",
            allowClear: true,
            width: '100%',
            dropdownParent: $('#customDateModal')
        });
    });

    // Lógica para o checkbox "Todos" no modal
    $('#status_todos').change(function() {
        const isChecked = $(this).is(':checked');
        $('.status-checkbox').not(this).prop('checked', isChecked);
    });
    
    // Se qualquer outro checkbox for desmarcado, desmarcar "Todos"
    $('.status-checkbox').not('#status_todos').change(function() {
        if (!$(this).is(':checked')) {
            $('#status_todos').prop('checked', false);
        } else {
            // Se todos os outros checkboxes estiverem marcados, marcar "Todos"
            const totalCheckboxes = $('.status-checkbox').not('#status_todos').length;
            const checkedCheckboxes = $('.status-checkbox').not('#status_todos').filter(':checked').length;
            
            if (totalCheckboxes === checkedCheckboxes) {
                $('#status_todos').prop('checked', true);
            }
        }
    });

    // Quando selecionar "Personalizado" no dropdown, abrir o modal
    $('#date-range').change(function() {
        if ($(this).val() === 'custom') {
            $('#customDateModal').modal('show');
        }
    });

    // Prevenir envio do formulário principal quando "Personalizado" estiver selecionado
    $('form').not('#customDateModal form').submit(function(e) {
        if ($('#date-range').val() === 'custom') {
            e.preventDefault();
            $('#customDateModal').modal('show');
        }
    });
});

// Função para limpar filtros no modal
function limparFiltrosModal() {
    // Limpa campos de data
    $('#data_inicio').val('');
    $('#data_fim').val('');
    
    // Reseta selects
    $('#cliente_modal').val('all').trigger('change');
    $('#colaborador_modal').val('all').trigger('change');
    $('#usuario_modal').val('all');
    
    // Desmarca todos os checkboxes e marca apenas "Todos"
    $('.status-checkbox').prop('checked', false);
    $('#status_todos').prop('checked', true);
}

// Função para aplicar filtros do modal
function aplicarFiltrosModal() {
    // Verifica se pelo menos um status está selecionado
    const statusSelecionados = $('.status-checkbox:checked').not('#status_todos').length;
    const todosSelecionado = $('#status_todos').is(':checked');
    
    if (!todosSelecionado && statusSelecionados === 0) {
        alert('Selecione pelo menos um status ou marque "Todos"');
        return false;
    }
    
    return true;
}
</script>
<script>
// Inicializa DataTable
$(document).ready(function() {
    const tabela = $('#datatablesSimple').DataTable({
        order: [[5, 'desc']], // ordena por "Data de Criação" (6ª coluna) mais recente primeiro
        language: {
            search: "Pesquisar:",
            lengthMenu: "Mostrar _MENU_ registros por página",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty: "Mostrando 0 a 0 de 0 registros",
            infoFiltered: "(filtrado de _MAX_ registros no total)",
            paginate: {
                first: "Primeiro",
                last: "Último",
                next: "Próximo",
                previous: "Anterior"
            },
            zeroRecords: "Nenhum resultado encontrado",
            emptyTable: "Nenhum dado disponível na tabela",
            loadingRecords: "Carregando...",
            processing: "Processando..."
        },
        dom: '<"top"f>rt<"bottom"lip><"clear">',
        responsive: true,
        pageLength: 25, // Itens por página padrão
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]], // Opções do menu
        columnDefs: [
            {
                // Coluna de Status (índice 4) - pode ser ordenável mas não pesquisável por texto
                targets: [4],
                searchable: false
            },
            {
                // Coluna de Valor (índice 6) - formatação numérica
                targets: [6],
                render: function(data, type, row) {
                    if (type === 'sort' || type === 'type') {
                        return data.replace('R$ ', '').replace('.', '').replace(',', '.');
                    }
                    return data;
                }
            }
        ]
    });
});
</script>
<script>
    // Função para limpar filtros do formulário principal
function limparFiltros() {
    // Resetar o select de período
    $('#date-range').val('30');
    
    // Resetar selects com Select2
    $('#cliente').val('all').trigger('change');
    $('#colaborador').val('all').trigger('change');
    $('#status').val('T');
    
    // Resetar select de usuário (se existir)
    if ($('#usuario').length) {
        $('#usuario').val('all');
    }
    
    // Opcional: recarregar a página para aplicar os filtros limpos
    window.location.href = "{% url 'relatorios' %}";
}

// Função para limpar filtros no modal
function limparFiltrosModal() {
    // Limpa campos de data
    $('#data_inicio').val('');
    $('#data_fim').val('');
    
    // Reseta selects
    $('#cliente_modal').val('all').trigger('change');
    $('#colaborador_modal').val('all').trigger('change');
    $('#usuario_modal').val('all');
    
    // Desmarca todos os checkboxes e marca apenas "Todos"
    $('.status-checkbox').prop('checked', false);
    $('#status_todos').prop('checked', true);
}

// Função para aplicar filtros do modal
function aplicarFiltrosModal() {
    // Verifica se pelo menos um status está selecionado
    const statusSelecionados = $('.status-checkbox:checked').not('#status_todos').length;
    const todosSelecionado = $('#status_todos').is(':checked');
    
    if (!todosSelecionado && statusSelecionados === 0) {
        alert('Selecione pelo menos um status ou marque "Todos"');
        return false;
    }
    
    return true;
}

// Inicializar Select2 e outras configurações
$(document).ready(function() {
    // Select2 do formulário principal
    $('#cliente').select2({
        placeholder: "Selecione um cliente",
        allowClear: true,
        width: '100%'
    });
    
    $('#colaborador').select2({
        placeholder: "Selecione um colaborador",
        allowClear: true,
        width: '100%'
    });
    
    // Inicializar Select2 dentro do modal quando aberto
    $('#customDateModal').on('shown.bs.modal', function () {
        $('#cliente_modal').select2({
            placeholder: "Selecione um cliente",
            allowClear: true,
            width: '100%',
            dropdownParent: $('#customDateModal')
        });
        
        $('#colaborador_modal').select2({
            placeholder: "Selecione um colaborador",
            allowClear: true,
            width: '100%',
            dropdownParent: $('#customDateModal')
        });
    });

    // Lógica para o checkbox "Todos" no modal
    $('#status_todos').change(function() {
        const isChecked = $(this).is(':checked');
        $('.status-checkbox').not(this).prop('checked', isChecked);
    });
    
    // Se qualquer outro checkbox for desmarcado, desmarcar "Todos"
    $('.status-checkbox').not('#status_todos').change(function() {
        if (!$(this).is(':checked')) {
            $('#status_todos').prop('checked', false);
        }
    });

    // Quando selecionar "Personalizado" no dropdown, abrir o modal
    $('#date-range').change(function() {
        if ($(this).val() === 'custom') {
            $('#customDateModal').modal('show');
        }
    });

    // Prevenir envio do formulário principal quando "Personalizado" estiver selecionado
    $('form').not('#customDateModal form').submit(function(e) {
        if ($('#date-range').val() === 'custom') {
            e.preventDefault();
            $('#customDateModal').modal('show');
        }
    });
});
</script>
{% endblock %}
